# Implementation Plan: Authentication & Security (JWT)

**Branch**: `002-authentication-jwt` | **Date**: 2026-01-09 | **Spec**: [specs/002-authentication-jwt/spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-authentication-jwt/spec.md`

**Note**: This plan is generated by the `/sp.plan` command and includes Phase 0-1 design guidance.

## Summary

Implement a stateless JWT-based authentication layer that securely connects the Next.js frontend (via Better Auth) to the FastAPI backend. All 6 API endpoints from Spec 001 will be protected with JWT validation middleware. The backend will verify JWT tokens using the shared BETTER_AUTH_SECRET environment variable and extract the authenticated user's identity to enforce data ownership. This enables multi-user isolation while maintaining scalability via stateless verification.

**Primary Responsibility Boundaries:**
- **Frontend**: User authentication (sign-up/sign-in) via Better Auth, JWT storage, and automatic Authorization header injection for all API calls
- **Backend**: JWT verification middleware, user identity extraction from token claims, route-level authorization enforcement, and 401/403 error responses

## Technical Context

**Language/Version**: TypeScript (Frontend: Next.js 16+), Python 3.11 (Backend: FastAPI)
**Primary Dependencies**:
  - Frontend: `better-auth` (TypeScript, JWT plugin), Next.js 16+ App Router, `ky` or `fetch` API (HTTP client)
  - Backend: `fastapi` (Python), `PyJWT` (JWT validation), `python-dotenv` (environment variables)
**Storage**: Neon PostgreSQL (persists user accounts; no session tables required for stateless auth)
**Testing**:
  - Frontend: Jest/Vitest with `better-auth` mocking
  - Backend: pytest with JWT token fixtures (valid, expired, invalid signatures)
**Target Platform**: Web (HTTP-based API, browser client)
**Project Type**: Full-stack web (Next.js + FastAPI with shared authentication)
**Performance Goals**: JWT validation <50ms per request (stateless = minimal overhead)
**Constraints**: <50ms token validation latency (from SC-011), stateless design (no backend session storage)
**Scale/Scope**: Multi-user SaaS (users authenticate once, use token for all requests; token expires after 7 days)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Requirement | Status | Notes |
|-----------|-------------|--------|-------|
| I. Spec-First Development | All functionality defined before implementation | ✅ PASS | Spec 002 complete with 6 user stories, 15 FRs, 12 SCs |
| II. Agentic Workflow Integrity | Implementation via Claude Code agents only | ✅ PASS | Plan will be decomposed into tasks for agent execution |
| III. Security by Design | Auth enforced at every layer; user isolation mandatory | ✅ PASS | Spec requires JWT validation on all endpoints, user_id matching, 401/403 responses |
| IV. User Isolation | Records owned by authenticated user; queries filter by user_id | ✅ PASS | FR-008 enforces user_id from JWT matches route path; backend filters all queries |
| V. Deterministic Behavior | All API behavior fully specified, no ambiguity | ✅ PASS | Spec defines exact HTTP status codes (401, 403), error message structure, JWT claims |
| VI. Reproducibility | Same spec+plan produces equivalent system behavior | ✅ PASS | Stateless JWT verification + environment variable configuration ensures reproducible validation logic |

**Constitution Gate Result**: ✅ **PASS** - All 6 principles satisfied. Spec does not conflict with Constitution requirements. Proceed to Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/002-authentication-jwt/
├── plan.md                          # This file (/sp.plan command output)
├── research.md                      # Phase 0 output (JWT libraries, Better Auth integration patterns)
├── data-model.md                    # Phase 1 output (JWT claims structure, authorization patterns)
├── quickstart.md                    # Phase 1 output (setup and integration guide)
├── contracts/
│   ├── jwt-auth-contract.md         # JWT claims and validation rules
│   └── authorization-flows.md       # Frontend/backend auth flow diagrams
└── tasks.md                         # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (Extends Spec 001 structure)

```text
# Backend (Python FastAPI)
backend/
├── src/
│   ├── auth/                        # NEW: Authentication module
│   │   ├── __init__.py
│   │   ├── jwt_middleware.py        # JWT validation middleware
│   │   ├── auth_context.py          # Authenticated user context extraction
│   │   └── auth_schemas.py          # Request/response models for auth
│   ├── api/
│   │   └── tasks.py                 # MODIFIED: Add @require_auth to all endpoints
│   ├── models.py                    # NO CHANGE: User model already exists
│   └── main.py                      # MODIFIED: Attach JWT middleware
└── tests/
    ├── test_jwt_validation.py       # NEW: JWT parsing, expiry, invalid signatures
    ├── test_protected_endpoints.py  # NEW: 401 responses for missing/invalid tokens
    └── test_user_isolation.py       # NEW: Multi-user scenario testing

# Frontend (Next.js)
frontend/
├── src/
│   ├── lib/
│   │   ├── auth/                    # NEW: Authentication module
│   │   │   ├── better-auth-config.ts  # Better Auth setup with JWT
│   │   │   ├── jwt-storage.ts         # JWT storage and retrieval
│   │   │   └── auth-context.tsx       # React context for auth state
│   │   ├── api/
│   │   │   └── client.ts            # NEW: API client with JWT middleware
│   ├── app/
│   │   ├── auth/                    # NEW: Auth pages
│   │   │   ├── signup/page.tsx      # Sign-up form and logic
│   │   │   ├── signin/page.tsx      # Sign-in form and logic
│   │   │   └── layout.tsx           # Auth layout wrapper
│   │   └── tasks/page.tsx           # MODIFIED: Requires auth, uses JWT client
│   └── middleware.ts                # NEW: Verify JWT on route access
└── tests/
    ├── auth.test.ts                 # NEW: JWT storage and retrieval
    └── api-client.test.ts           # NEW: Authorization header injection
```

**Structure Decision**: Option 2 - Web application (Next.js frontend + FastAPI backend). Authentication is cross-cutting concern affecting both frontend and backend. Frontend has new `/app/auth/` routes for sign-up/sign-in. Backend has new `src/auth/` module with JWT middleware. Existing `/api/tasks` endpoints are enhanced with authentication requirement (no breaking changes to endpoint signatures).

## Complexity Tracking

> No Constitution violations requiring justification. Project structure aligns with spec-first, agentic workflow, and security-by-design principles.

---

## Phase 0: Research & Resolution

**Objective**: Resolve all technical unknowns and capture implementation patterns.

### Research Tasks

| Task | Unknowns | Deliverable |
|------|----------|-------------|
| Better Auth JWT Integration | How to enable JWT plugin in Better Auth? What configuration is needed? Token storage strategy? | research.md section: Better Auth Setup |
| JWT Claims Structure | What claims does Better Auth include in JWT? How to extract user_id? Format of token payload? | research.md section: JWT Claims Design |
| PyJWT Usage Patterns | How to validate JWT in FastAPI middleware? Library API? Error handling for expired/invalid tokens? | research.md section: Backend JWT Validation |
| Stateless Auth Best Practices | How to structure middleware for zero-database JWT validation? Error responses for 401/403? | research.md section: Stateless Verification Pattern |
| Next.js API Middleware | How to attach Authorization header in Next.js? Client-side middleware patterns? HttpOnly cookie vs localStorage? | research.md section: Frontend Auth Client |

**Phase 0 Output**: `specs/002-authentication-jwt/research.md` with all sections completed.

---

## Phase 1: Design & Contracts

**Objective**: Define data models, API contracts, and integration patterns. Re-validate Constitution Check post-design.

### 1a. Data Model Generation

**File**: `specs/002-authentication-jwt/data-model.md`

**JWT Claims Structure**:
```
{
  "sub": "<user_id>",           # Subject (user identifier)
  "email": "<user_email>",      # User email from account
  "iat": <unix_timestamp>,      # Issued at time
  "exp": <unix_timestamp>,      # Expiration time (iat + 7 days)
  "iss": "better-auth",         # Issuer (Better Auth)
  "aud": "taskie-api"           # Audience (our app)
}
```

**Authorization Context**:
```
AuthenticatedUser {
  user_id: str              # From JWT "sub" claim
  email: str                # From JWT "email" claim
  token_issued_at: datetime # From JWT "iat"
  token_expires_at: datetime # From JWT "exp"
}
```

### 1b. API Contracts

**Files**:
- `specs/002-authentication-jwt/contracts/jwt-auth-contract.md` - JWT claims, validation rules, expiration policy
- `specs/002-authentication-jwt/contracts/authorization-flows.md` - Sign-up/sign-in/authenticated-request flows

**Key Contracts**:

1. **JWT Bearer Token Header** (all protected requests)
   ```
   Authorization: Bearer <JWT_TOKEN>
   ```

2. **Protected Endpoint Pattern**
   - Requirement: Valid JWT in Authorization header
   - Extraction: Middleware extracts user_id from token claims
   - Route Enforcement: user_id in JWT must match {user_id} in path
   - Response on Auth Failure: 401 Unauthorized

3. **Authentication Flow (Frontend)**
   ```
   Sign-Up: Email + Password → Better Auth → JWT → Store JWT → Return to App
   Sign-In: Email + Password → Better Auth → JWT → Store JWT → Return to App
   API Call: Retrieve JWT from storage → Attach to Authorization header → Send request
   ```

4. **Authorization Flow (Backend)**
   ```
   Receive Request:
     1. Extract Authorization header
     2. Parse "Bearer <token>"
     3. Validate JWT signature using BETTER_AUTH_SECRET
     4. Check exp claim (not expired)
     5. Extract user_id from "sub" claim
     6. Compare JWT user_id with route path {user_id}
     7. If match: Pass user context to handler; if mismatch: Return 403
   ```

### 1c. Quickstart Guide

**File**: `specs/002-authentication-jwt/quickstart.md`

Contents:
- Frontend setup: Installing Better Auth, configuring JWT plugin, environment variables
- Backend setup: Installing PyJWT, configuring middleware, environment variables
- Testing: Sample curl commands with valid/invalid JWT tokens
- Troubleshooting: Common errors and debugging steps

### 1d. Constitution Check (Post-Design)

Re-validate all principles with designed solution:

| Principle | Validation | Status |
|-----------|-----------|--------|
| I. Spec-First | Design derived entirely from Spec 002 requirements | ✅ PASS |
| II. Agentic Workflow | All code will be generated by agents (no manual coding) | ✅ PASS |
| III. Security by Design | JWT validation middleware, user ownership checks in all endpoints | ✅ PASS |
| IV. User Isolation | JWT user_id matches route path; all queries filter by authenticated user | ✅ PASS |
| V. Deterministic Behavior | All HTTP status codes (401, 403) and error messages specified in contracts | ✅ PASS |
| VI. Reproducibility | Stateless JWT + BETTER_AUTH_SECRET environment variable ensures consistent validation | ✅ PASS |

**Constitution Gate Result**: ✅ **RE-VALIDATED PASS** - Design phase complete. No violations detected. Ready for task breakdown.

---

## Phase 2: Task Breakdown (via `/sp.tasks` command)

**Input**: This plan.md file
**Output**: `specs/002-authentication-jwt/tasks.md` (NOT created by /sp.plan)

The `/sp.tasks` command will:
1. Parse the 7 implementation phases defined in user input
2. Break each phase into granular, testable tasks
3. Create dependency graph for parallel execution
4. Assign tasks to appropriate agents (Backend Architect, Auth Security Reviewer, NextJS UI Optimizer)
5. Generate test criteria for each task

---

## Implementation Strategy

### Agent Assignments

| Component | Agent | Responsibility |
|-----------|-------|-----------------|
| Backend JWT Middleware | Backend Architect + Auth Security Reviewer | Implement jwt_middleware.py, error handling, token validation |
| Frontend Better Auth Integration | NextJS UI Optimizer + Auth Security Reviewer | Configure Better Auth, sign-up/sign-in pages, JWT storage |
| API Client JWT Attachment | NextJS UI Optimizer | Create API client that auto-injects Authorization header |
| Protected Endpoint Updates | Backend Architect | Add auth requirement to existing 6 endpoints without changing logic |
| Integration Tests | Auth Security Reviewer | Multi-user isolation tests, token expiration tests, cross-user access attempts |

### Success Indicators (Per Phase)

- **Phase 1** (Auth Architecture): BETTER_AUTH_SECRET configured identically on both frontend and backend
- **Phase 2** (Better Auth Setup): Frontend successfully obtains JWT token on sign-in; token contains user_id and exp claims
- **Phase 3** (Frontend API Client): All API requests include `Authorization: Bearer <JWT>` header
- **Phase 4** (JWT Middleware): Backend validates token signature and expiry; rejects invalid tokens with 401
- **Phase 5** (Auth Context): Request context includes authenticated user_id; handlers can access user information
- **Phase 6** (Route Authorization): All endpoints verify user_id from JWT matches route path; mismatches return 403
- **Phase 7** (Error Handling): All error responses follow contract (401 for missing/expired/invalid, 403 for ownership mismatch)

---

## Deliverables Checklist

By end of implementation, these artifacts must exist:

- [ ] Phase 0: `specs/002-authentication-jwt/research.md` (JWT libraries, auth patterns)
- [ ] Phase 1: `specs/002-authentication-jwt/data-model.md` (JWT claims, AuthUser context)
- [ ] Phase 1: `specs/002-authentication-jwt/contracts/jwt-auth-contract.md`
- [ ] Phase 1: `specs/002-authentication-jwt/contracts/authorization-flows.md`
- [ ] Phase 1: `specs/002-authentication-jwt/quickstart.md` (setup guide)
- [ ] Phase 2: `specs/002-authentication-jwt/tasks.md` (generated by /sp.tasks)
- [ ] Backend: `backend/src/auth/jwt_middleware.py` (JWT validation)
- [ ] Backend: `backend/src/auth/auth_context.py` (user extraction)
- [ ] Backend: `backend/src/auth/auth_schemas.py` (request models)
- [ ] Backend: `backend/main.py` (middleware attachment)
- [ ] Backend: `backend/src/api/tasks.py` (auth requirement on endpoints)
- [ ] Backend: `backend/tests/test_jwt_validation.py` (token validation tests)
- [ ] Backend: `backend/tests/test_protected_endpoints.py` (401/403 tests)
- [ ] Backend: `backend/tests/test_user_isolation.py` (multi-user tests)
- [ ] Frontend: `frontend/src/lib/auth/better-auth-config.ts` (Better Auth setup)
- [ ] Frontend: `frontend/src/lib/auth/jwt-storage.ts` (token storage)
- [ ] Frontend: `frontend/src/lib/auth/auth-context.tsx` (React context)
- [ ] Frontend: `frontend/src/lib/api/client.ts` (JWT-injecting client)
- [ ] Frontend: `frontend/src/app/auth/signup/page.tsx` (sign-up form)
- [ ] Frontend: `frontend/src/app/auth/signin/page.tsx` (sign-in form)
- [ ] Frontend: `frontend/src/middleware.ts` (route protection)
- [ ] Frontend: `frontend/tests/auth.test.ts` (JWT storage tests)
- [ ] Frontend: `frontend/tests/api-client.test.ts` (header injection tests)
