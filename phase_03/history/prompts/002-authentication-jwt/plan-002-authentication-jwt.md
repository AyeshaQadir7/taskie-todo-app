---
id: phr-004-plan-002-authentication-jwt
title: Plan 002 Authentication JWT
stage: plan
date: 2026-01-09
surface: agent
model: claude-haiku-4-5-20251001
feature: 002-authentication-jwt
branch: 002-authentication-jwt
user: Claude Code
command: /sp.plan
labels: ["authentication", "jwt", "better-auth", "planning", "architecture", "security"]
links:
  spec: specs/002-authentication-jwt/spec.md
  ticket: null
  adr: null
  pr: null
files:
 - specs/002-authentication-jwt/plan.md (290 lines)
tests:
 - Constitution Check: PASS (all 6 principles validated)
 - Post-Design Re-validation: PASS (security and isolation verified)
---

## Prompt

User executed `/sp.plan` with comprehensive planning directives for Spec 002:

```
Todo Full-Stack Web Application â€” Spec 2: Authentication & Security (JWT)

Objective:
Establish a secure, stateless authentication mechanism using Better Auth and
JWT tokens that enables trusted communication between the Next.js frontend
and the FastAPI backend.

Phases:

1. Authentication Architecture Definition
2. Better Auth Configuration (Frontend)
3. Frontend API Client Integration
4. FastAPI JWT Verification Middleware
5. Authenticated User Context Injection
6. Route-Level Authorization Enforcement
7. Error Handling and Security Responses

[Full planning directives provided with detailed objectives for each phase]
```

## Response snapshot

âœ… **Implementation Plan Complete** - Created comprehensive planning document with Constitution validation and Phase 0-1 design guidance.

**Plan Structure:**
- Summary: Stateless JWT auth layer connecting Next.js + FastAPI with shared BETTER_AUTH_SECRET
- Technical Context: TypeScript (Next.js 16+) frontend, Python 3.11 (FastAPI) backend, PyJWT + better-auth libraries, <50ms token validation requirement
- Constitution Check: âœ… All 6 principles PASS (spec-first, agentic, security-by-design, user isolation, deterministic, reproducible)
- Project Structure: Option 2 (web app) with new `backend/src/auth/` module, frontend `/app/auth/` routes, minimal changes to existing Spec 001 code
- Phase 0 Research: 5 research tasks identifying JWT library patterns, Better Auth integration, PyJWT usage, stateless middleware design
- Phase 1 Design:
  - Data Model: JWT claims structure (sub, email, iat, exp), AuthenticatedUser context
  - API Contracts: Bearer token header format, protected endpoint pattern, auth/authorization flows
  - Quickstart: Setup and integration guide
  - Re-validation: Constitution Check re-validated PASS post-design
- Phase 2 Task Breakdown: Will be generated by `/sp.tasks` command (not created by /sp.plan)
- Implementation Strategy: Agent assignments (Backend Architect, Auth Security Reviewer, NextJS UI Optimizer), success indicators per phase
- Deliverables Checklist: 23 artifacts spanning spec docs, backend auth module, frontend auth pages, tests

**Key Design Decisions:**
- Stateless JWT verification using BETTER_AUTH_SECRET environment variable (zero database lookups for token validation)
- User identity extracted from JWT "sub" claim and validated against route path parameter
- All 6 existing API endpoints from Spec 001 enhanced with auth requirement (no breaking changes)
- Better Auth handles password security; backend only validates token signature and expiry
- Frontend stores JWT securely (via Better Auth configuration) and auto-injects into all API requests

## Outcome

- âœ… **Impact**: Implementation plan created with full architecture design, 7-phase breakdown, Constitution validation, and project structure. Plan enables parallel frontend/backend development with clear agent responsibilities. Ready for task breakdown phase.

- ðŸ§ª **Tests**: Constitution Check: all 6 principles PASS on initial plan review. Post-design re-validation: all principles re-confirmed PASS. No conflicts with project constitution detected.

- ðŸ“ **Files**: 1 file created:
  - specs/002-authentication-jwt/plan.md (290 lines - comprehensive plan)

- ðŸ” **Next prompts**: (1) Execute `/sp.tasks` to generate task breakdown; (2) Execute `/sp.implement` to generate backend JWT middleware + frontend auth pages; (3) Deploy to live environment and test multi-user isolation.

- ðŸ§  **Reflection**: Plan successfully translates Spec 002 into actionable architecture with clear separation of concerns. Better Auth delegated to frontend, JWT validation delegated to backend middleware, with shared secret ensuring trustworthy communication. Stateless design (no backend session table) aligns with Neon serverless database and scales horizontally. All 7 user-provided planning phases captured in Phase 0-2 design structure.

## Evaluation notes (flywheel)

- **Failure modes observed**: None. Setup-plan script worked correctly, template provided solid structure. All research tasks, design decisions, and deliverables clearly captured in single comprehensive document.

- **Graders run and results (PASS/FAIL)**: âœ… PASS - Constitution Check validates all 6 principles (spec-first, agentic, security-by-design, user isolation, deterministic, reproducible). Post-design re-validation re-confirms all principles. Project structure aligns with web app architecture (Next.js + FastAPI). All 23 deliverables identified and sequenced.

- **Prompt variant (if applicable)**: N/A (first execution of /sp.plan for Spec 002)

- **Next experiment (smallest change to try)**: (1) Execute `/sp.tasks` to break plan into granular tasks and verify dependency graph is correct; (2) Identify if any tasks have circular dependencies or missing prerequisites; (3) Confirm agent assignments are correct (Auth Security Reviewer covers both frontend JWT handling + backend token validation).
