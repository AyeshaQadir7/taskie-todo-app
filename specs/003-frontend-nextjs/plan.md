# Implementation Plan: Frontend Application (Next.js)

**Branch**: `003-frontend-nextjs` | **Date**: 2026-01-10 | **Spec**: [specs/003-frontend-nextjs/spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-frontend-nextjs/spec.md`

**Note**: This plan is generated by the `/sp.plan` command and includes Phase 0-1 design guidance.

## Summary

Implement a fully responsive Next.js 16+ frontend application that enables authenticated users to manage their todo tasks. The application integrates with the FastAPI backend (Spec 001) via RESTful API endpoints secured with JWT authentication (Spec 002). Users will authenticate via Better Auth sign-up/sign-in flows, automatically include JWT tokens in all API requests through a centralized HTTP client, and interact with a responsive task management UI optimized for mobile, tablet, and desktop screens. The frontend abstracts JWT handling from UI components through a React Context-based auth service, enabling clean component separation and maintainable code architecture.

**Primary Responsibility Boundaries:**
- **Frontend (Spec 003)**: User interface, authentication flows (sign-up/sign-in/sign-out), task CRUD operations via API client, responsive design, error handling, route protection
- **Backend (Spec 001/002)**: REST API endpoints, database operations, JWT validation, user isolation enforcement, authorization checks

## Technical Context

**Language/Version**: TypeScript (Next.js 16+ with App Router), Node.js 18+
**Primary Dependencies**:
  - `next` 16+ (App Router framework)
  - `better-auth` (JWT authentication library)
  - `tailwindcss` (responsive styling)
  - `typescript` (type safety)
  - HTTP client: `fetch` API (built-in) or `ky` (lightweight alternative)
  - Form handling: React hooks (`useState`, `useCallback`) or `react-hook-form` (optional)
**Storage**: HttpOnly cookies (JWT token storage set by backend via Set-Cookie header)
**Testing**: Jest/Vitest with React Testing Library (unit/component tests), manual testing via cURL/Postman for API integration
**Target Platform**: Web (browser-based, responsive across mobile/tablet/desktop)
**Project Type**: Web application (frontend only, consumes external REST API)
**Performance Goals**: Page load <2s desktop, <3s mobile; API request roundtrip <500ms; responsive interactions <200ms
**Constraints**: HttpOnly cookie enforcement (no localStorage), JWT auto-injection for all API calls, responsive breakpoints (320px, 768px, 1024px+), zero hardcoded values
**Scale/Scope**: Multi-user SaaS frontend (unlimited users, each manages their own tasks via authenticated API)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Requirement | Status | Notes |
|-----------|-------------|--------|-------|
| I. Spec-First Development | All functionality defined before implementation | ✅ PASS | Spec 003 complete with 10 user stories, 25 FRs, 15 SCs, edge cases |
| II. Agentic Workflow Integrity | Implementation via Claude Code agents only | ✅ PASS | Plan will be decomposed into tasks for agent execution via `/sp.tasks` |
| III. Security by Design | Auth enforced at every layer; user isolation mandatory | ✅ PASS | Frontend enforces route protection; JWT auto-injected; 401 triggers redirect; no hardcoded user IDs |
| IV. User Isolation | Records owned by authenticated user; queries filter by user_id | ✅ PASS | User ID extracted from JWT; all API calls include {user_id} in path; UI displays only authenticated user's tasks |
| V. Deterministic Behavior | All API behavior fully specified, no ambiguity | ✅ PASS | Spec defines all HTTP status codes (201 create, 404 not found, 401 unauthorized), form validation rules, redirect flows |
| VI. Reproducibility | Same spec+plan produces equivalent system behavior | ✅ PASS | Frontend behavior is deterministic: routes, forms, API client, error handling all specified; no runtime variation |

**Constitution Gate Result**: ✅ **PASS** - All 6 principles satisfied. Spec does not conflict with Constitution requirements. Proceed to Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/003-frontend-nextjs/
├── plan.md                          # This file (/sp.plan command output)
├── research.md                      # Phase 0 output (Next.js patterns, Better Auth setup, API client design)
├── data-model.md                    # Phase 1 output (UI component hierarchy, state management, data flow)
├── quickstart.md                    # Phase 1 output (setup, environment variables, running the application)
├── contracts/
│   ├── api-client-contract.md       # API client expectations (JWT injection, error handling)
│   ├── auth-flow-contract.md        # Sign-up/sign-in/sign-out flows and state transitions
│   └── component-contract.md        # React component interfaces and props
└── tasks.md                         # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (Frontend Only)

```text
frontend/
├── src/
│   ├── app/                         # Next.js 16+ App Router
│   │   ├── layout.tsx               # Root layout (providers, auth wrapper)
│   │   ├── page.tsx                 # Homepage (redirect to /tasks or /auth/signin)
│   │   ├── (auth)/                  # Auth routes group
│   │   │   ├── layout.tsx           # Auth layout (centered form, no navbar)
│   │   │   ├── signup/
│   │   │   │   └── page.tsx         # Sign-up form page
│   │   │   ├── signin/
│   │   │   │   └── page.tsx         # Sign-in form page
│   │   │   └── signout/
│   │   │       └── page.tsx         # Sign-out confirmation page
│   │   ├── (dashboard)/             # Protected routes group
│   │   │   ├── layout.tsx           # Dashboard layout (navbar, sidebar, main content)
│   │   │   ├── tasks/
│   │   │   │   ├── page.tsx         # Task list page (GET /api/{user_id}/tasks)
│   │   │   │   ├── [taskId]/
│   │   │   │   │   └── page.tsx     # Task detail/edit page (GET/PUT /api/{user_id}/tasks/{id})
│   │   │   │   └── new/
│   │   │   │       └── page.tsx     # Create task page (POST /api/{user_id}/tasks)
│   │   │   └── profile/
│   │   │       └── page.tsx         # User profile page (sign-out button, user info)
│   │   └── error.tsx                # Error boundary page
│   ├── components/                  # Reusable React components
│   │   ├── auth/
│   │   │   ├── SignUpForm.tsx       # Sign-up form component
│   │   │   ├── SignInForm.tsx       # Sign-in form component
│   │   │   ├── ProtectedRoute.tsx   # Route protection wrapper
│   │   │   └── AuthGuard.tsx        # Auth context consumer (redirect if not authenticated)
│   │   ├── tasks/
│   │   │   ├── TaskList.tsx         # Display array of tasks
│   │   │   ├── TaskItem.tsx         # Single task display with edit/delete/complete buttons
│   │   │   ├── TaskForm.tsx         # Create/edit task form
│   │   │   ├── EmptyState.tsx       # Empty task list message
│   │   │   └── TaskLoadingSpinner.tsx # Loading state for task operations
│   │   ├── common/
│   │   │   ├── Navbar.tsx           # Top navigation with sign-out button
│   │   │   ├── Button.tsx           # Reusable button component
│   │   │   ├── Input.tsx            # Reusable form input component
│   │   │   ├── ErrorAlert.tsx       # Error message display
│   │   │   └── LoadingSpinner.tsx   # Loading indicator
│   │   └── layout/
│   │       ├── Container.tsx        # Responsive container wrapper
│   │       └── ResponsiveGrid.tsx   # Grid layout for responsive design
│   ├── lib/                         # Utilities and services
│   │   ├── auth/
│   │   │   ├── auth-context.tsx     # React Context for auth state (currentUser, isAuthenticated, loading)
│   │   │   ├── useAuth.ts           # Custom hook to access auth context
│   │   │   ├── better-auth-config.ts # Better Auth configuration and initialization
│   │   │   └── jwt-storage.ts       # JWT token storage/retrieval (HttpOnly cookies)
│   │   ├── api/
│   │   │   ├── client.ts            # Centralized HTTP client with JWT auto-injection
│   │   │   └── types.ts             # API response types (Task, User, etc.)
│   │   ├── hooks/
│   │   │   ├── useTasks.ts          # Custom hook for task CRUD operations (uses API client)
│   │   │   ├── useAsync.ts          # Generic async operation hook (loading, error, data states)
│   │   │   └── useLocalStorage.ts   # Local storage hook (optional, for non-sensitive data)
│   │   └── validation/
│   │       ├── auth.ts              # Email/password validation rules
│   │       └── tasks.ts             # Task title/description validation rules
│   ├── middleware.ts                # Next.js middleware for route protection
│   ├── utils/
│   │   ├── classnames.ts            # Utility for conditional CSS classes
│   │   └── formatting.ts            # Date formatting, text truncation, etc.
│   └── styles/
│       ├── globals.css              # Global styles (Tailwind config, base styles)
│       └── variables.css            # CSS variables for theme (colors, spacing, etc.)
├── public/                          # Static assets
│   ├── favicon.ico
│   └── images/
├── .env.example                     # Environment variable template
├── .env.local                       # Local development variables (git-ignored)
├── tailwind.config.js               # Tailwind CSS configuration
├── tsconfig.json                    # TypeScript configuration
├── next.config.js                   # Next.js configuration
├── package.json                     # NPM dependencies
└── README.md                        # Project documentation (setup, running, debugging)

tests/                              # Testing
├── unit/
│   ├── auth.test.ts                # JWT storage, auth context tests
│   └── validation.test.ts          # Form validation tests
├── integration/
│   ├── auth-flow.test.ts           # Sign-up/sign-in/sign-out flow tests
│   └── task-crud.test.ts           # Task CRUD operation tests
└── e2e/                            # End-to-end tests (Cypress, Playwright) - OPTIONAL
    └── user-journey.test.ts        # Full user signup → task creation → edit → delete flow
```

**Structure Decision**: Single Next.js frontend application (App Router) consuming external FastAPI backend. Authentication is cross-cutting (affects all pages). Core structure uses route groups `(auth)` and `(dashboard)` to organize page layouts. Reusable components in `/components/` enable code sharing across pages. `/lib/auth/` provides centralized authentication service via React Context. `/lib/api/` provides centralized HTTP client with JWT injection.

## Complexity Tracking

> No Constitution violations requiring justification. Project structure aligns with spec-first, agentic workflow, and security-by-design principles.

---

## Phase 0: Research & Resolution

**Objective**: Resolve all technical unknowns and capture implementation patterns specific to Next.js frontend development.

### Research Tasks

| Task | Unknowns | Deliverable |
|------|----------|-------------|
| Next.js 16+ App Router Best Practices | Route groups, layouts, middleware, page components? How to organize app structure for authentication? | research.md section: Next.js App Router Architecture |
| Better Auth Integration Patterns | How to configure Better Auth in Next.js? JWT token access in React components? Sign-up/sign-in flow mechanics? | research.md section: Better Auth Setup in Next.js |
| React Context for Auth State | How to structure useAuth hook? Global auth state management patterns? Handling JWT in context? | research.md section: Authentication Context Design |
| HttpOnly Cookie Handling | How to store JWT as HttpOnly cookie from backend? Frontend can't access directly; how to verify authentication? | research.md section: HttpOnly Cookie Strategy |
| API Client with JWT Auto-Injection | How to create centralized HTTP client in Next.js? Interceptors for Authorization header? Error handling for 401 responses? | research.md section: API Client with Middleware |
| Form Validation Best Practices | Client-side validation patterns in Next.js? Email validation, password strength, required fields? Error message display? | research.md section: Form Validation & Error Handling |
| Responsive Design with Tailwind | Mobile-first approach with Tailwind? Breakpoints (320px, 768px, 1024px)? Touch-friendly button sizing? | research.md section: Tailwind CSS Responsive Design |
| Next.js Middleware for Route Protection | How to protect routes from unauthenticated access? Middleware.ts patterns? Redirects to sign-in? | research.md section: Route Protection Middleware |
| Handling JWT Expiration | How to detect 401 responses? Automatic redirect to sign-in? Retry logic for expired tokens? | research.md section: JWT Expiration & Error Recovery |
| Loading States & Optimistic Updates | Loading spinners during API calls? Disabling form buttons? Showing error messages? User feedback best practices? | research.md section: Loading States & User Feedback |

**Phase 0 Output**: `specs/003-frontend-nextjs/research.md` with all sections completed.

---

## Phase 1: Design & Contracts

**Objective**: Define data models, component architecture, API contracts, and integration patterns. Re-validate Constitution Check post-design.

### 1a. Component Architecture & State Management

**File**: `specs/003-frontend-nextjs/data-model.md`

**Authentication State Model**:
```typescript
interface AuthContext {
  currentUser: { id: string; email: string } | null
  isAuthenticated: boolean
  isLoading: boolean
  signUp: (email: string, password: string) => Promise<void>
  signIn: (email: string, password: string) => Promise<void>
  signOut: () => Promise<void>
  error: string | null
}
```

**Task State Model**:
```typescript
interface Task {
  id: number
  user_id: string
  title: string
  description?: string
  status: 'complete' | 'incomplete'
  created_at: string
  updated_at: string
}

interface TasksState {
  tasks: Task[]
  isLoading: boolean
  error: string | null
}

interface TaskActions {
  fetchTasks: (userId: string) => Promise<void>
  createTask: (userId: string, data: TaskInput) => Promise<Task>
  updateTask: (userId: string, taskId: number, data: TaskInput) => Promise<Task>
  deleteTask: (userId: string, taskId: number) => Promise<void>
  completeTask: (userId: string, taskId: number) => Promise<Task>
}
```

**Component Hierarchy**:
```
App Root (layout.tsx)
├── AuthProvider (Context wrapper)
├── RouteGroup: (auth)
│   ├── SignUpPage
│   │   └── SignUpForm
│   └── SignInPage
│       └── SignInForm
└── RouteGroup: (dashboard)
    ├── Navbar (Auth-dependent: shows user or sign-out button)
    ├── TaskListPage
    │   ├── TaskForm (create new)
    │   ├── TaskList
    │   │   └── TaskItem (edit/delete/complete buttons)
    │   └── EmptyState
    ├── TaskDetailPage
    │   └── TaskForm (edit existing)
    └── ProfilePage
        └── SignOut button
```

### 1b. API Contracts

**File**: `specs/003-frontend-nextjs/contracts/api-client-contract.md`

**API Client Responsibilities**:
```typescript
// All requests automatically include JWT Authorization header
// All responses are parsed as JSON and typed
// 401 responses trigger auth context update and redirect to /auth/signin

POST /api/{user_id}/tasks
- Headers: Authorization: Bearer <JWT>
- Body: { title: string, description?: string }
- Response 201: { id, user_id, title, description, status, created_at, updated_at }
- Response 401: Unauthorized (redirect to signin)

GET /api/{user_id}/tasks
- Headers: Authorization: Bearer <JWT>
- Response 200: Task[]
- Response 401: Unauthorized (redirect to signin)

GET /api/{user_id}/tasks/{task_id}
- Headers: Authorization: Bearer <JWT>
- Response 200: Task
- Response 404: Not Found (task doesn't exist or user doesn't own it)
- Response 401: Unauthorized

PUT /api/{user_id}/tasks/{task_id}
- Headers: Authorization: Bearer <JWT>
- Body: { title: string, description?: string }
- Response 200: Task (updated)
- Response 404: Not Found
- Response 401: Unauthorized

PATCH /api/{user_id}/tasks/{task_id}/complete
- Headers: Authorization: Bearer <JWT>
- Response 200: Task (status updated)
- Response 404: Not Found
- Response 401: Unauthorized

DELETE /api/{user_id}/tasks/{task_id}
- Headers: Authorization: Bearer <JWT>
- Response 204: No Content
- Response 404: Not Found
- Response 401: Unauthorized
```

**Authentication Context Contract**:
```typescript
// useAuth() hook provides:
- currentUser: { id: string; email: string } | null
- isAuthenticated: boolean (true if currentUser is not null and JWT is valid)
- isLoading: boolean (true during sign-up/sign-in/auth check)
- signUp(email, password): Promise<void> (throws on validation error or duplicate email)
- signIn(email, password): Promise<void> (throws on invalid credentials)
- signOut(): Promise<void> (clears JWT and resets auth state)
- error: string | null (user-friendly error message)
```

**Form Validation Contract**:
```typescript
// Client-side validation before API call
Email validation:
  - Must be valid email format (RFC 5322 simplified)
  - Required field
  - Display: "Please enter a valid email address"

Password validation (sign-up):
  - Minimum 8 characters
  - Display: "Password must be at least 8 characters"
  - Client-side only (Better Auth handles backend validation)

Password validation (sign-in):
  - None (backend determines validity)

Task title validation:
  - Required field (cannot be empty)
  - Display: "Task title is required"
  - Maximum 500 characters (spec limit)
  - Display: "Task title must be less than 500 characters"

Task description validation:
  - Optional field
  - Maximum 2000 characters
  - Display: "Description must be less than 2000 characters"
```

### 1c. Route & Page Contracts

**File**: `specs/003-frontend-nextjs/contracts/routing-contract.md`

**Public Routes** (accessible without authentication):
```
GET  /                    → Redirect to /tasks (if authenticated) or /auth/signin (if not)
GET  /auth/signup         → Sign-up form page
GET  /auth/signin         → Sign-in form page
POST /auth/signup         → Form submission (via API call, internal)
POST /auth/signin         → Form submission (via API call, internal)
POST /auth/signout        → Sign-out action (via API call, internal)
```

**Protected Routes** (require valid JWT token; redirect to /auth/signin if not authenticated):
```
GET  /tasks              → Task list page (displays all user's tasks)
GET  /tasks/new          → Create task form page
GET  /tasks/[taskId]     → Task detail/edit page
POST /tasks              → Create task (form submission)
PUT  /tasks/[taskId]     → Update task (form submission)
DELETE /tasks/[taskId]   → Delete task (button click)
PATCH /tasks/[taskId]/complete → Toggle completion (button click)
GET  /profile            → User profile page (sign-out button)
POST /profile/signout    → Sign-out action (button click)
```

**Error Routes**:
```
GET  /404                → Page not found (404 error boundary)
GET  /500                → Server error (500 error boundary)
GET  /* (any not matched) → Redirect to 404 or show error
```

### 1d. Responsive Design Contract

**File**: `specs/003-frontend-nextjs/contracts/responsive-design-contract.md`

**Breakpoints**:
```css
Mobile (320px - 767px):
  - Single column layout
  - Full-width buttons (min 44px height)
  - Font size: 16px base
  - Padding: 16px horizontal
  - Task list: each task as full-width card
  - Forms: full-width inputs

Tablet (768px - 1023px):
  - Two-column layout where appropriate
  - Buttons: min 40px height
  - Font size: 16px base
  - Padding: 24px horizontal
  - Task list: cards in 2-column grid

Desktop (1024px+):
  - Full-width layout with max-width container (1200px)
  - Buttons: min 40px height
  - Font size: 16px base
  - Padding: 32px horizontal
  - Task list: cards in 3+ column grid or table view
  - Navbar: horizontal layout with user info and sign-out button
```

**Touch-Friendly Sizing**:
```
Button minimum: 44px × 44px (mobile), 40px × 40px (tablet/desktop)
Input field minimum height: 44px (mobile), 40px (tablet/desktop)
Checkbox/radio: 20px × 20px minimum
Form gaps: 16px (mobile), 20px (tablet/desktop)
```

### 1e. Quickstart Guide

**File**: `specs/003-frontend-nextjs/quickstart.md`

**Quick Setup**:
1. Clone repository and navigate to frontend/ folder
2. Install dependencies: `npm install`
3. Copy `.env.example` to `.env.local` and fill in values:
   - `NEXT_PUBLIC_API_BASE_URL=http://localhost:8000`
   - `NEXT_PUBLIC_BETTER_AUTH_SECRET=<from backend .env>`
4. Start development server: `npm run dev`
5. Open http://localhost:3000 in browser
6. Sign up with test email, create tasks, verify API calls in browser DevTools

**Running the Application**:
- Development: `npm run dev` (http://localhost:3000)
- Build: `npm run build`
- Production: `npm start`
- Tests: `npm test` or `npm run test:watch`

**Environment Variables**:
- `NEXT_PUBLIC_API_BASE_URL`: Backend API base URL (e.g., http://localhost:8000)
- `NEXT_PUBLIC_BETTER_AUTH_SECRET`: Shared JWT secret (must match backend)
- `NODE_ENV`: Development or production environment

---

## Phase 1 Completion: Constitution Check Re-validation

After Phase 1 design and contract generation, all Constitution principles remain satisfied:

- ✅ **Spec-First**: Spec 003 fully specified; design is implementation of spec requirements
- ✅ **Agentic**: Design will be executed by agent-generated code via `/sp.tasks`
- ✅ **Security**: Route protection, JWT auto-injection, 401 redirect all designed into contracts
- ✅ **User Isolation**: API client filters by user_id; no hardcoded values; centralized auth
- ✅ **Deterministic**: All behavior specified in contracts; no runtime variation
- ✅ **Reproducible**: Same design produces same component structure, API client behavior, and UI state

**Result**: ✅ **PASS** - Proceed to Phase 2 task breakdown via `/sp.tasks`.

---

## Next Steps

Execute `/sp.tasks` to decompose this plan into granular, ordered implementation tasks with dependencies and test cases. Tasks will be organized by user story priority (P1 before P2) and by phase (initialization → auth → API client → pages → responsiveness → error handling).

